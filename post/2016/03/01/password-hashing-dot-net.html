<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Sapiensworks | C# (.Net) Password Hashing The Easy Way</title>
  <meta name="description" content="Converting tech into business advantage">
  <meta name="author" content="Mike Mogosanu">
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:description" content="In-depth technical articles for developers who want to deliver more business value"/>
<meta name="twitter:title" content="SapiensWorks -  C# (.Net) Password Hashing The Easy Way"/>
<meta name="twitter:site" content="@sapiensworks"/>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gridlex/2.6.1/gridlex.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
 <link rel="alternate" type="application/atom+xml" title="Sapiensworks Articles" href="/feed.atom" />
  <link rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <link rel="stylesheet" href="/style.css">
  <script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5a3b096e9d192f001374336b&product=sop' async='async'></script>
</head>
<body>
<header>
  <div class="grid-noGutter-middle">
    <div class="col-4_xs-12_sm-12" data-push-left="off-4_sm-0_xs-0">
      
          <h1 class="title">  <a href="/">  Sapiens Works </a> </h1>
      
      

      </div>
      
      <div class="col-3_xs-8_sm-8 text-center" data-push-left="off-1_xs-1_sm-1"><a href="https://twitter.com/sapiensworks">
        <span class="fa fa-twitter-square fa-2x"></span></a>
        <a href="https://github.com/sapiens">
        <span class="fa fa-github-square fa-2x"></span></a>
        <a href="http://stackoverflow.com/users/1017868/mikesw">
        <span class="fa fa-stack-overflow fa-2x"></span></a>
        <!-- <a href="/feed.atom">
        <span class="fa fa-rss-square fa-2x"></span></a> -->
      </div>
    
    
  </div>
  <div class="grid-middle-center-noGutter">
      <div class="col-3_xs-12_sm-12"><span class="tagline">Converting tech into business advantage</span></div>
    
    </div>
    
        <nav class="grid-center-noGutter-middle main-menu">
            
            <a href="/tags.html" class="col-1_xs-3_sm-3">
              <span>Topics</span>
            </a>
            <a href="/about.html" class="col-1_xs-3_sm-3">
              <span>About</span>
            </a>
            
         
            
          </nav>

    
    

 
  

  


  
</header>
<main>



 <article>
    <header>
      <h1>C# (.Net) Password Hashing The Easy Way</h1>
      <div class="article-meta">
      <span>published on &nbsp; <b>01 March 2016</b></span> in <a href="/tags.html#.net">.net</a>
    </div>
    </header>
  <div class="post">
 
<p>We know we shouldn't store passwords at all, not even encrypted nevermind in plain text. And by encrypted I mean something like AES, Base64 encoding is <em>not</em> encryption. In a nutshell, we need to store only salted hashes so that a password can't be reversed and an attacker shouldn't find a common pattern that will lead to breaking the password. As any developer knows, we want a hash which is slow to generate, so fast algorithms like MD5, Murmur or the SHA family shouldn't be used. For best results something like bcrypt or Pbkdf2 should be used with a high number of iterations.</p>
<p>In order to make things easy, I've come up with a value object that does the 'hard' work and it's versatile enough to allow you to customize things. It's a class called <code>PasswordHash</code> available as part of my <a href="https://www.nuget.org/packages/CavemanTools/4.0.0">CavemanTools</a> library or you can copy/paste the code directly from <a href="https://github.com/sapiens/cavemantools/blob/master/src/CavemanTools/PasswordHash.cs">here</a> .</p>
<p>First thing is to decide on the hash length and I suggest to set a value &gt; 32. This value should vary from one app to another and should be secret. I also recommend to set a (secret)salt size and a (secret) iteration count.</p>
<pre><code class="language-csharp">PasswordHash.KeySize = 40; //default is 32
PasswordHash.DefaultSaltSize = 32; //default is 32 
PasswordHash.DefaultIterations = 70000; //default is 64000
</code></pre>
<p>Be aware that the number of iterations affects the hash generation time. The default is a good value (it takes around 200ms on my PC) but you might want to increase that for sensitive apps.</p>
<p>Let's use it</p>
<pre><code class="language-csharp">var pwd = new PasswordHash(&quot;some pwd&quot;);

//store as bytes
store(pwd.Hash);

//store as string
store(pwd.ToString());

//restore from string
var pwd=PasswordHash.FromHash(hash,PasswordHash.DefaultSaltSize,PasswordHash.DefaultIterations);

//restore from bytes
 var pwd = new PasswordHash(hash, PasswordHash.DefaultSaltSize, PasswordHash.DefaultIterations);
 
 //check pasword
 if (pwd.IsValidPassword(&quot;other pwd&quot;)) { }
</code></pre>
<h3>Customizing how the final hash is generated</h3>
<p>Regardless of how you keep it in the database, it's important to be aware that the final hash is a combination of salt and the password hash. By default, salt is stored first then the password hash. And that's why we want to change the passwords hash length or/and the salt size, so that an attacker would have a hard time guessing when the salt ends and when the hash begins. If an attacker knows either, they already have 2 pieses of the puzzle.</p>
<p>Another way is to change how the salt and hash are stored.</p>
<pre><code class="language-csharp">PasswordHash.PackBytes = (data) =&gt; /* return a byte[] containing the salt/hash stored in a creative manner*/;
PasswordHash.UnpackBytes = (packed,saltSize) =&gt;  /* 'recover' the salt and password hash */;
</code></pre>
<p>Basically, we have these options to ensure an attacker won't have an easy job:</p>
<ul>
<li>Variable/Secret key (password hash) length</li>
<li><em>and/or</em> Variable/Secret iterations count</li>
<li><em>and/or</em> Variable/Secret salt size</li>
<li><em>and/or</em> Your own 'pack/unpack' algorithm</li>
</ul>
<p>This way, even if an attacker knows you're using <code>PasswordHash</code> they still have to guess the above.</p>

 </div>
 <footer>
   <div class="sharethis-inline-share-buttons"></div>
 <a class="previous" href="/post/2016/01/25/aurelia-submit-on-enter.html">&laquo; Previous</a> 
 <a class="next" href="/post/2016/03/02/ado-net-manual-mapping.html">Next &raquo;</a>    
 </footer>
  </article>;

  <section id="comments">
  
      <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
      
            var disqus_shortname = 'sapiensworks';
      
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
      
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
      
        </section>
</main>
<footer>
    © 2018 SapiensWorks.com 
</footer>
<script>hljs.initHighlightingOnLoad();</script>
<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-2037614-18', 'auto');
		ga('send', 'pageview', {
		  'page': '/',
		  'title': ''
		});
	</script>
	<!-- End Google Analytics -->
</body>
</html>