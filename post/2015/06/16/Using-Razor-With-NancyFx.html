<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Sapiensworks | How To Use Razor with NancyFx</title>
  <meta name="description" content="Converting tech into business advantage">
  <meta name="author" content="Mike Mogosanu">
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:description" content="In-depth technical articles for developers who want to deliver more business value"/>
<meta name="twitter:title" content="SapiensWorks -  How To Use Razor with NancyFx"/>
<meta name="twitter:site" content="@sapiensworks"/>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gridlex/2.6.1/gridlex.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
 <!-- <link rel="alternate" type="application/atom+xml" title="Sapiensworks Articles" href="/feed.atom" /> -->
  <link rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <link rel="stylesheet" href="/style.css">
  <script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5a3b096e9d192f001374336b&product=sop' async='async'></script>
</head>
<body>
<header>
  <div class="grid-noGutter-middle">
    <div class="col-4_xs-12_sm-12" data-push-left="off-4_sm-0_xs-0">
      
          <h1 class="title">  <a href="/">  Sapiens Works </a> </h1>
      
      

      </div>
      
      <div class="col-3_xs-8_sm-8 text-center" data-push-left="off-1_xs-1_sm-1"><a href="https://twitter.com/sapiensworks">
        <span class="fa fa-twitter-square fa-2x"></span></a>
        <a href="https://github.com/sapiens">
        <span class="fa fa-github-square fa-2x"></span></a>
        <a href="http://stackoverflow.com/users/1017868/mikesw">
        <span class="fa fa-stack-overflow fa-2x"></span></a>
        <!-- <a href="/feed.atom">
        <span class="fa fa-rss-square fa-2x"></span></a> -->
      </div>
    
    
  </div>
  <div class="grid-middle-center-noGutter">
      <div class="col-3_xs-12_sm-12"><span class="tagline">Converting tech into business advantage</span></div>
    
    </div>
    
        <nav class="grid-center-noGutter-middle main-menu">
            
            <a href="/tags.html" class="col-1_xs-3_sm-3">
              <span>Topics</span>
            </a>
            <a href="/about.html" class="col-1_xs-3_sm-3">
              <span>About</span>
            </a>
            
         
            
          </nav>

    
    

 
  

  


  
</header>
<main>



 <article>
    <header>
      <h1>How To Use Razor with NancyFx</h1>
      <div class="article-meta">
      <span>published on &nbsp; <b>16 June 2015</b></span> in <a href="/tags.html#.net">.net</a>
    </div>
    </header>
  <div class="post">
 
<p>After using Nancy to build an Api app, I've decided to give it a try and use it instead of Asp.Net Mvc. I was a bit weary because I knew things are not that straightforward when it comes to Razor. Turns out I was partially right.</p>
<p>But first things first. The <a href="https://github.com/NancyFx/Nancy/wiki/Razor-View-Engine">docs</a> do a pretty good job explaining how to configure Razor, however there are some gotchas.</p>
<ol>
<li>Every bit of code you'll use in a razor view if it happens to be in a different assembly than the view, needs to be <strong>manually</strong> referenced, regardless if the current assembly reference it and your view has the required using statement. Coming from Asp.net Mvc you might be tempted to configure razor in app/web.config. Personally, I find it easier to use the programmatic option, that is implementing <code>IRazorConfig</code>. Now, everytime you need an assembly referenced in a Razor view just add it to that class.</li>
</ol>
<p>Here's an example</p>
<pre><code class="language-csharp">
 public class RazorConfig : IRazorConfiguration
   {
       public IEnumerable&lt;string&gt; GetAssemblyNames()
       {
           yield return &quot;System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;;
           yield return &quot;Common&quot;;

           yield return &quot;HtmlTags&quot;;

       }

       public IEnumerable&lt;string&gt; GetDefaultNamespaces()
       {
        //contains html extensions
        yield return &quot;Web._Auxilia.Html&quot;;

       }

       public bool AutoIncludeModelNamespace
       {
           get { return true; }
       }
   }

</code></pre>
<p>While my webapp references System.Web and other assemblies, I still need to include it here for Razor to know about it. And this needs to be done when refactoring moves some code (used by the view) from one assembly to another or one namespace to another.</p>
<ol start="2">
<li><p>All of your views need the <code>&#64;inherits Nancy.ViewEngines.Razor.NancyRazorViewBase&lt;My_Model&gt;</code> with full path for the view base, instead of <code>&#64;model MyModel</code> . This is easily solvable with a file template (at least if using Resharper).</p>
</li>
<li><p>When defining a view convention the path <strong>should not start</strong> with '/' .</p>
</li>
</ol>
<h2>View Conventions</h2>
<p>And speaking of view conventions, this is a very nice part of Nancy (you can get a similar feature in Asp.Net Mvc using my <a href="https://github.com/sapiens/MvcPowerTools/wiki/ViewEngine">MvcPowerTools library</a>) that allows you to configure the view path you want. This means that you can put your some of your views in a View directory, others in next to the Nancy module or the view model itself. All these with just a couple lines of code.</p>
<p>Here's an example</p>
<pre><code class="language-csharp">
 //in my nancy bootstrapper
protected override void ConfigureConventions(NancyConventions nancyConventions)
       {
           ConfigureViews(nancyConventions);
       }

       private static void ConfigureViews(NancyConventions nancyConventions)
       {
           nancyConventions.ViewLocationConventions.Clear();
        nancyConventions.ViewLocationConventions.Insert(0, (view, model, ctx) =&gt; &quot;{1}/{0}&quot;.ToFormat(view, ctx.ModulePath));
           nancyConventions.ViewLocationConventions.Add((view, model, ctx) =&gt;
           {
               var tp=(model.GetType() as Type);
               var asm=tp.Assembly.GetName().Name;
               var path = tp.Namespace.Substring(asm.Length+1).Replace('.','/');

               //path is model namespace without the assembly name
               return &quot;{0}/{1}&quot;.ToFormat(path,view);
           });

           nancyConventions.ViewLocationConventions.Add((view, model, ctx) =&gt; &quot;common/{0}&quot;.ToFormat(view));
       }

</code></pre>
<p>Since I don't want to use any existing conventions, I clear the list and define my own. The first convention tells the engine to look for the view in a directory that has the same name as the module path. This usually happens if the module is used to define an equivalent to a asp.net mvc area. And usually, the module itself is in a directory with that name.</p>
<p>The next convention is the most interesting one. It's for views sitting next to their view model. While in asp.net mvc returning a <code>View(model)</code> meant the view name is the action name found in a controller (or Shared) directory, in Nancy <code>return View[model]</code> looks for a view with the model type name (but without the &quot;Model&quot; suffix). And this might be strange but it's actually a great feature: just look at the view/model name and you already know the model/view name ;) . Also this means you should use one view model per view. And as a tip, <strong>always</strong> define a view model even if you plan to reuse an existing data structure. It's a very small price to pay for maintainability.</p>
<p>As you can see there's no view extension mentioned. That's because the view locator searches for all files with that name regardless of their extensions and then uses the found extension to identify the view engine. This way, switching for Razor to Spark (for example) means you just have to install the Spark view engine and your code stays untouched.</p>
<h2>Html Tags and Helpers</h2>
<p>In this regard, you don't have much. While there is a nuget bringing the asp.net mvc html helpers to Nancy, it's pre release and it's a port. This is not wrong, but I do prefer a more fluent (read: not ugly) way of doing things. Besides writing the html code directly , which I don't recommend as a general thumb rule, you can use the <a href="https://github.com/darthfubumvc/htmltags">HtmlTags</a> library to define your own Html Helpers for Nancy. It's more work but it's trivial and you get some cool benefits.</p>
<p>Here's an example of a 'register user' form</p>
<pre><code class="language-html">
 &lt;form action=&quot;/register&quot; method=&quot;POST&quot;&gt;

    &#64;Html.HiddenTag(d=&gt;d.OperationId).Raw()
    &lt;div class=&quot;form-group&quot;&gt;

        &#64;Html.Label(d=&gt;d.Fullname).Raw()
        &#64;Html.Textbox(d=&gt;d.Fullname).AddClass(&quot;form-control&quot;).Raw()
        &#64;Html.ValidationText(d=&gt;d.Fullname).Raw()

    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;

        &#64;Html.Label(d=&gt;d.Email).Raw()
        &#64;Html.Textbox(d=&gt;d.Email).Raw()
        &#64;Html.ValidationText(d=&gt;d.Email).Raw()

    &lt;/div&gt;
    &#64;Html.FormField(d=&gt;d.Password,()=&gt;Html.Textbox(d=&gt;d.Password).PasswordMode())

    &lt;div class=&quot;form-group&quot;&gt;
        &lt;input type=&quot;checkbox&quot; name=&quot;RememberMe&quot; value=&quot;true&quot;/&gt;&lt;label&gt;Remember Me&lt;/label&gt;
    &lt;/div&gt;

    &lt;button type=&quot;submit&quot;&gt;Go&lt;/button&gt;

 &lt;/form&gt;

</code></pre>
<p>All the helpers are defined by me, they just provide a simple way to use HtmlTags in a Razor view. Here's a small excerpt</p>
<pre><code class="language-csharp">
      public static TextboxTag Textbox&lt;T&gt;(this HtmlHelpers&lt;T&gt; html,Expression&lt;Func&lt;T,object&gt;&gt; valueSelector)
       {
           var name = valueSelector.GetName();
           return html.Textbox(name);
       }

      public static TextboxTag Textbox&lt;T&gt;(this HtmlHelpers&lt;T&gt; html, string name)
      {
          var val = html.Model.GetPropertyValue(name) ?? &quot;&quot;;
          return new TextboxTag(name, val.ToString()).IdFromName();
      }

       public static HiddenTag HiddenTag&lt;T&gt;(this HtmlHelpers&lt;T&gt; html, Expression&lt;Func&lt;T, object&gt;&gt; valueSelector)
       {
           var name = valueSelector.GetName();
           var result= new HiddenTag();
           result.Name(name).IdFromName();
           return result;
       }

      public static IHtmlString FormField&lt;T&gt;(this HtmlHelpers&lt;T&gt; html, Expression&lt;Func&lt;T, object&gt;&gt; valueSelector,
           Func&lt;HtmlTag&gt; factory = null)
       {
           if (factory == null)
           {
               factory = () =&gt; html.Textbox(valueSelector);
           }
           var result = new DivTag().AddClass(&quot;form-group&quot;);
           result
               .Append(html.Label(valueSelector))
               .Append(factory())
               .Append(html.ValidationText(valueSelector));
           return result.Raw();
       }

       public static HtmlTag ValidationText&lt;T&gt;(this HtmlHelpers&lt;T&gt; html, Expression&lt;Func&lt;T, object&gt;&gt; valueSelector)
       {
           var name = valueSelector.GetName();
           return html.ValidationText(name);
       }
       public static HtmlTag ValidationText&lt;T&gt;(this HtmlHelpers&lt;T&gt; html, string name)
       {
           var result = html.RenderContext.Context.ModelValidationResult;
           if (result.IsValid) return HtmlTag.Empty();
           var error = result.Errors.GetValueOrDefault(name, new ModelValidationError[0]).FirstOrDefault();
           if (error==null) return HtmlTag.Empty();
           var tag=new SpanTag();
           tag.Text(error.ErrorMessage);
           return tag.AddClass(&quot;error&quot;);
       }

       public static IHtmlString Raw(this HtmlTag tag)
        {
            return new NonEncodedHtmlString(tag.ToString());
        }

</code></pre>
<p>Some interesting things:</p>
<ul>
<li>All (almost) helpers return a <code>HtmlTag</code> object or a type inheriting <code>HtmlTag</code></li>
<li>Because Razor html encodes everything, we need to tell it to not encode the tag, hence the <code>Raw()</code> extension method</li>
<li>Validation result object (created by a call to <code>Validate</code> or <code>BindAndValidate</code> in a Nancy module) can be found at <code>[html helper].RenderContext.Context.ModelValidationResult</code> . That's where the <code>ValidationText</code> takes the errors messages from.</li>
</ul>
<p>Creating your own helpers means it's easier to add changes later. For example, I can decide to create a helper <code>AsSubmit()</code> for a button or link tag, which can add or remove a specific css class or attribute or include directly a css class for a specific tag (such as &quot;form-control&quot; for textboxes). HtmlTags library has some support for defining your own html conventions (that can manipulate tag generation based on model) but the docs are lacking in this regard, AFAIK is still work in progress.</p>
<h2>Conclusion</h2>
<p>Clearly, using Razor with Nancy is not as smooth as with Asp.Net Mvc, but for me it's not a big deal. I like Nancy as a framework and the 'price' for using razor is quite small once you have a workflow defined. Actually, I'd say it's easier for a asp.net veteran to write a maintainable app with Nancy, while it's easier for a beginner to use Asp.Net Mvc. You can do everything with both, but with Nancy <strong>you</strong> are more in control.</p>

 </div>
 <footer>
   <div class="sharethis-inline-share-buttons"></div>
 <a class="previous" href="/post/2015/05/25/DDD-Concepts-As-One-Liners.html">&laquo; Previous</a> 
 <a class="next" href="/post/2015/06/19/Functional-Programming-Holy-Wars.html">Next &raquo;</a>    
 </footer>
  </article>;

  <section id="comments">
  
      <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
      
            var disqus_shortname = 'sapiensworks';
      
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
      
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
      
        </section>
</main>
<footer>
    © 2018 SapiensWorks.com 
</footer>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>