<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Sapiensworks | Invoking A Private Method On A Subclass</title>
  <meta name="description" content="Converting tech into business advantage">
  <meta name="author" content="Mike Mogosanu">
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:description" content="In-depth technical articles for developers who want to deliver more business value"/>
<meta name="twitter:title" content="SapiensWorks -  Invoking A Private Method On A Subclass"/>
<meta name="twitter:site" content="@sapiensworks"/>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gridlex/2.6.1/gridlex.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
 <!-- <link rel="alternate" type="application/atom+xml" title="Sapiensworks Articles" href="/feed.atom" /> -->
  <link rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <link rel="stylesheet" href="/style.css">
  <!-- <script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5a3b096e9d192f001374336b&product=sop' async='async'></script> -->
</head>
<body>
<header>
  <div class="grid-noGutter-middle">
    <div class="col-4_xs-12_sm-12" data-push-left="off-4_sm-0_xs-0">
      
          <h1 class="title">  <a href="/">  Sapiens Works </a> </h1>
      
      

      </div>
      
      <div class="col-3_xs-8_sm-8 text-center" data-push-left="off-1_xs-1_sm-1"><a href="https://twitter.com/sapiensworks">
        <span class="fa fa-twitter-square fa-2x"></span></a>
        <a href="https://github.com/sapiens">
        <span class="fa fa-github-square fa-2x"></span></a>
        <a href="http://stackoverflow.com/users/1017868/mikesw">
        <span class="fa fa-stack-overflow fa-2x"></span></a>
        <!-- <a href="/feed.atom">
        <span class="fa fa-rss-square fa-2x"></span></a> -->
      </div>
    
    
  </div>
  <div class="grid-middle-center-noGutter">
      <div class="col-3_xs-12_sm-12"><span class="tagline">Converting tech into business advantage</span></div>
    
    </div>
    
        <nav class="grid-center-noGutter-middle main-menu">
            
            <a href="/tags.html" class="col-1_xs-3_sm-3">
              <span>Topics</span>
            </a>
            <a href="/about.html" class="col-1_xs-3_sm-3">
              <span>About</span>
            </a>
            
         
            
          </nav>

    
    

 
  

  


  
</header>
<main>



 <article>
    <header>
      <h1>Invoking A Private Method On A Subclass</h1>
      <div class="article-meta">
      <span>published on &nbsp; <b>19 April 2012</b></span> in <a href="/tags.html#.net">.net</a>
    </div>
    </header>
  <div class="post">
 
<p>I was just (re)watching Greg Young's <a href="http://www.infoq.com/presentations/Events-Are-Not-Just-for-Notifications">Event Sourcing Presentation</a> when the following code appeared on slides</p>
<pre><code class="language-csharp">public abstract class Aggregate
 {
      private void ApplyChange(Event &#64;event,bool isNew)
        {
            this.AsDynamic().Apply(&#64;event);           
            if (isNew) _changes.Add(d);
        }
}

</code></pre>
<p>Greg tells the audience that this method does some black magic(.Net only) to basically call an Apply method defined in a subtype, like this</p>
<pre><code class="language-csharp">public class SubType: Aggregate
{
     private Apply(DeactivatedItemEvent &#64;event)
	 {
	    _deactivated=true;
	 }
}


</code></pre>
<p>Of course the scenario was that there are have many overloads of Apply, each for a different event. With this trick, you just write the method and that's it. The compiler and the runtime will work for you to select the correct overload.<br />
So I was curious about the magic that made the call possible. You might think that a simple</p>
<pre><code class="language-csharp">private dynamic AsDynamic() { return this; }


</code></pre>
<p>is enough. But it isn't. In fact, it will throw an exception that the member is inaccessible. So what can we do? If you're browsing to Greg's CQRS application example you'll see some complicated implementation of DynamicObject which does 2 things: uses reflection (member.Invoke) to call the private method and does nothing if the method is missing. Now, the performance is good enough (around 1 second for 100 000 calls) but surely we can do better?</p>
<p>After some messing around, I've come up with 3 ways to do it, besides reflection.</p>
<ol start="2">
<li>The simplest way is to just make the method public , but that's kinda defeats the purpose of encapsulation. Not really an option.</li>
<li>Another way is to define an abstract method that will be implemented by the sub type</li>
</ol>
<pre><code class="language-csharp">
public class Aggregate
{
  private void ApplyChange(Event d,bool isNew)
        {
            ApplyX(d);
           
            if (isNew) _changes.Add(d);
        }

        protected abstract void ApplyX(Event d); 
}

public class SubType: Aggregate
{
     protected override void ApplyX(Event d)
        {
            Apply((dynamic)d);
        }
}


</code></pre>
<p>Casting the argument to dynamic does the trick here and this is the fastest implementation (around 185 ms for 100 000 method calls). But you have to write that override for every subtype. Not a high price to pay to get the best performance, IMO.</p>
<ol start="6">
<li>Write a dynamic method which will invoke a private method, directly without reflection</li>
</ol>
<pre><code class="language-csharp">
public class Aggregate
{
         protected void ApplyX(Event d)
        {
            var evt = d.GetType();
            lock (_locker)
            {
                if (!_invokers.ContainsKey(evt))
                {
                    DynamicMethod met = new DynamicMethod(&quot;invoker&quot;, typeof(void), new[] { typeof(EventEntityBase), typeof(Event) }, typeof(EventEntityBase).Module, true);
                    var il = met.GetILGenerator();
                    il.Emit(OpCodes.Ldarg_0);//subtype           
                    il.Emit(OpCodes.Ldarg_1);//event
                    il.Emit(OpCodes.Call, GetType().GetMethod(&quot;Apply&quot;, BindingFlags.Instance | BindingFlags.NonPublic, null, new[] { d.GetType() }, null));//call apply
                    il.Emit(OpCodes.Ret);
                    var del = (Invoker)met.CreateDelegate(typeof(Invoker));
                    _invokers[evt] = del;
                }
            }
            _invokers[evt](this, d);
        }


        static object _locker = new object();
        static Dictionary&lt;Type, Invoker&gt; _invokers = new Dictionary&lt;Type, Invoker&gt;();

        public delegate void Invoker(EventEntityBase bs, Event ev); 
}


</code></pre>
<p>In a nutshell, a static method is created via Reflection.Emit, then used via a delegate, nothing fancy here. The delegate is cached for further reuse. This approach doesn't require anything implemented by the subtype so everything is contained by the base class. However its performance was a bit of surprise as it's slower than using dynamic directly (around 260ms for 100 000 method calls).   There you have it. You can choose the reflection way, which is the slowest or to use the dynamic feature of C# (almost 10x faster) but requires the subtype support or to emit a dynamic method ('only' 5x times faster). I think I'm going to use the approach with the dynamic keyword.</p>

 </div>
 <footer>
   <div class="sharethis-inline-share-buttons"></div>
 <a class="previous" href="/post/2012/04/18/ddd-aggregates-and-aggregates-root-explained.aspx.html">&laquo; Previous</a> 
 <a class="next" href="/post/2012/04/20/dont-use-orm-entities-to-model-the-domain.aspx.html">Next &raquo;</a>    
 </footer>
  </article>;

  <section id="comments">
  
      <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
      
            var disqus_shortname = 'sapiensworks';
      
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
      
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
      
        </section>
</main>
<footer>
    © 2018 SapiensWorks.com 
</footer>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>